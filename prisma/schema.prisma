generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String            @id @default(cuid())
  email              String            @unique
  password           String?
  name               String?
  profileImageUrl    String?           @map("profile_image_url")
  emailVerified      DateTime?         @map("email_verified")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  lastActive         DateTime          @default(now()) @map("last_active")
  status             UserStatus        @default(ACTIVE)
  invitationId       String?           @unique @map("invitation_id")
  conversations      Conversation[]
  approvedVersions   DocumentVersion[] @relation("VersionApprover")
  rejectedVersions   DocumentVersion[] @relation("VersionRejector")
  uploadedVersions   DocumentVersion[] @relation("VersionUploader")
  submittedDocuments Document[]        @relation("DocumentSubmitter")
  tenants            TenantMember[]
  invitation         UserInvitation?   @relation(fields: [invitationId], references: [id])

  @@map("users")
}

model TenantMember {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  tenantId  String    @map("tenant_id")
  role      UserRole?
  isOwner   Boolean   @default(false) @map("is_owner")
  joinedAt  DateTime  @default(now()) @map("joined_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags      Tag[]     @relation("TagToTenantMember")

  @@unique([userId, tenantId])
  @@map("tenant_members")
}

model Tenant {
  id            String           @id @default(cuid())
  name          String
  subdomain     String?          @unique
  logoUrl       String?          @map("logo_url")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  assistantId   String?          @map("assistant_id")
  balance       Float            @default(10.0)
  totalSpent    Float            @default(0) @map("total_spent")
  apiKeys       ApiKey[]
  conversations Conversation[]
  documents     Document[]
  tags          Tag[]
  members       TenantMember[]
  tokenUsage    TokenUsage[]
  invitations   UserInvitation[]
  widget        Widget?

  @@map("tenants")
}

model UserInvitation {
  id        String           @id @default(cuid())
  email     String
  role      UserRole?
  status    InvitationStatus @default(PENDING)
  token     String           @unique
  invitedBy String           @map("invited_by")
  tenantId  String           @map("tenant_id")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")
  expiresAt DateTime         @map("expires_at")
  tagIds    String[]         @default([]) @map("tag_ids")
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?

  @@unique([email, tenantId])
  @@map("user_invitations")
}

model Document {
  id              String            @id @default(cuid())
  name            String
  description     String?
  submittedBy     String            @map("submitted_by")
  tenantId        String            @map("tenant_id")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  activeVersionId String?           @unique @map("active_version_id")
  currentVersion  Int               @default(1) @map("current_version")
  versions        DocumentVersion[]
  activeVersion   DocumentVersion?  @relation("ActiveVersion", fields: [activeVersionId], references: [id])
  submittedByUser User              @relation("DocumentSubmitter", fields: [submittedBy], references: [id])
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accessTags      Tag[]             @relation("DocumentToTag")

  @@map("documents")
}

model DocumentVersion {
  id                String          @id @default(cuid())
  documentId        String          @map("document_id")
  versionNumber     Int             @map("version_number")
  originalName      String          @map("original_name")
  fileUrl           String          @map("file_url")
  fileKey           String          @unique @map("file_key")
  fileSize          Int             @map("file_size")
  mimeType          String          @map("mime_type")
  status            DocumentStatus  @default(PENDING)
  uploadedBy        String          @map("uploaded_by")
  approvedBy        String?         @map("approved_by")
  rejectedBy        String?         @map("rejected_by")
  rejectionReason   String?         @map("rejection_reason")
  createdAt         DateTime        @default(now()) @map("created_at")
  approvedAt        DateTime?       @map("approved_at")
  rejectedAt        DateTime?       @map("rejected_at")
  changeNotes       String?         @map("change_notes")
  chunks            DocumentChunk[]
  approvedByUser    User?           @relation("VersionApprover", fields: [approvedBy], references: [id])
  document          Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  rejectedByUser    User?           @relation("VersionRejector", fields: [rejectedBy], references: [id])
  uploadedByUser    User            @relation("VersionUploader", fields: [uploadedBy], references: [id])
  activeForDocument Document?       @relation("ActiveVersion")

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@map("document_versions")
}

model DocumentChunk {
  id         String           @id @default(cuid())
  content    String
  chunkIndex Int              @map("chunk_index")
  embedding  Float[]
  metadata   String?
  createdAt  DateTime         @default(now()) @map("created_at")
  versionId  String?          @map("version_id")
  version    DocumentVersion? @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@map("document_chunks")
}

model Conversation {
  id        String    @id @default(cuid())
  title     String
  userId    String    @map("user_id")
  tenantId  String    @map("tenant_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  threadId  String?   @map("thread_id")
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId, tenantId])
  @@map("conversations")
}

model Message {
  id             String           @id @default(cuid())
  conversationId String           @map("conversation_id")
  role           MessageRole
  content        String
  createdAt      DateTime         @default(now()) @map("created_at")
  feedback       MessageFeedback?
  sources        Json?
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

model Widget {
  id             String   @id @default(cuid())
  tenantId       String   @unique @map("tenant_id")
  enabled        Boolean  @default(true)
  widgetId       String   @unique @map("widget_id")
  primaryColor   String   @default("#3B82F6") @map("primary_color")
  secondaryColor String   @default("#1E40AF") @map("secondary_color")
  position       String   @default("bottom-right")
  title          String   @default("AI Assistant")
  welcomeMessage String   @default("Hello! How can I help you today?") @map("welcome_message")
  placeholder    String   @default("Type your message...")
  showBranding   Boolean  @default(true) @map("show_branding")
  customCss      String?  @map("custom_css")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("widgets")
}

model ApiKey {
  id             String        @id @default(cuid())
  tenantId       String        @map("tenant_id")
  name           String
  keyHash        String        @unique @map("key_hash")
  prefix         String
  expirationDate DateTime?     @map("expiration_date")
  isEnabled      Boolean       @default(true) @map("is_enabled")
  dailyLimit     Float         @default(0) @map("daily_limit")
  monthlyLimit   Float         @default(0) @map("monthly_limit")
  lastUsedAt     DateTime?     @map("last_used_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  usage          ApiKeyUsage[]
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([keyHash])
  @@map("api_keys")
}

model ApiKeyUsage {
  id           String   @id @default(cuid())
  apiKeyId     String   @map("api_key_id")
  date         DateTime @db.Date
  cost         Float    @default(0)
  requestCount Int      @default(0) @map("request_count")
  createdAt    DateTime @default(now()) @map("created_at")
  apiKey       ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@unique([apiKeyId, date])
  @@index([apiKeyId, date])
  @@map("api_key_usage")
}

model Tag {
  id            String         @id @default(cuid())
  tenantId      String         @map("tenant_id")
  name          String
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents     Document[]     @relation("DocumentToTag")
  tenantMembers TenantMember[] @relation("TagToTenantMember")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("tags")
}

model TokenUsage {
  id               String   @id @default(cuid())
  tenantId         String   @map("tenant_id")
  date             DateTime @db.Date
  model            String
  provider         String   @default("OpenAI")
  promptTokens     Int      @default(0) @map("prompt_tokens")
  completionTokens Int      @default(0) @map("completion_tokens")
  totalTokens      Int      @default(0) @map("total_tokens")
  cost             Float    @default(0)
  requestCount     Int      @default(0) @map("request_count")
  createdAt        DateTime @default(now()) @map("created_at")
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date, model])
  @@index([tenantId, date])
  @@map("token_usage")
}

model BillingTransaction {
  id          String            @id @default(cuid())
  tenantId    String            @map("tenant_id")
  type        TransactionType
  amount      Float
  description String?
  status      TransactionStatus @default(COMPLETED)
  reference   String?
  createdAt   DateTime          @default(now()) @map("created_at")

  @@unique([tenantId, reference])
  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@map("billing_transactions")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum UserRole {
  ADMIN
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MessageRole {
  USER
  ASSISTANT
}

enum MessageFeedback {
  POSITIVE
  NEGATIVE
}

enum TransactionType {
  TOP_UP
  CHARGE
  REFUND
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}
